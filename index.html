<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#386A20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ToDodo</title>
  <link rel="stylesheet" href="style.css"/>
  
  
  <!-- Inter Font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome for Icons (e.g., plus, trash) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Add inline script for immediate button handling -->
  <script>
    // Track open modal
    let inlineActiveModal = null;
    
    // Close all open modals
    function closeInlineModals() {
      // Remove any existing date/category modal
      document.querySelectorAll('.date-picker-modal, .category-modal').forEach(modal => {
        modal.remove();
      });
      inlineActiveModal = null;
    }
    
    // Position a modal below its trigger button
    function positionModalBelowButton(modal, button) {
      const buttonRect = button.getBoundingClientRect();
      const buttonBottom = buttonRect.bottom + window.scrollY;
      const buttonLeft = buttonRect.left + window.scrollX;
      
      // Position the modal
      modal.style.position = 'absolute';
      modal.style.top = `${buttonBottom + 5}px`; // 5px gap below button
      modal.style.left = `${buttonLeft}px`;
      modal.style.zIndex = '1000';
      
      // Ensure modal doesn't extend past viewport width
      setTimeout(() => {
        const modalRect = modal.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        
        if (modalRect.right > viewportWidth) {
          // Adjust to keep it in viewport
          const overflow = modalRect.right - viewportWidth;
          const newLeft = Math.max(5, buttonLeft - overflow - 10); // Keep at least 5px from left edge
          modal.style.left = `${newLeft}px`;
        }
      }, 0);
    }
    
    // Direct event handlers as a fallback
    document.addEventListener('DOMContentLoaded', function() {
      console.log("Direct event handlers initialized");
      
      // Global click handler to close modals when clicking outside
      document.addEventListener('click', function(e) {
        if (inlineActiveModal && 
            !e.target.closest('.date-picker-modal') && 
            !e.target.closest('.category-modal') && 
            !e.target.closest('#toggle-date-btn') && 
            !e.target.closest('#toggle-category-btn')) {
          closeInlineModals();
        }
      });
      
      // Add click handlers to critical buttons
      setTimeout(function() {
        try {
          // Date button handler
          const dateBtn = document.getElementById('toggle-date-btn');
          if (dateBtn) {
            dateBtn.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Date button clicked via direct handler");
              
              // Close any existing modals first
              closeInlineModals();
              
              // Create a simple date picker
              const modal = document.createElement('div');
              modal.className = 'date-picker-modal';
              
              // Set styles for the modal
              modal.style.backgroundColor = '#fff';
              modal.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
              modal.style.borderRadius = '8px';
              modal.style.padding = '20px';
              modal.style.maxWidth = '90%';
              modal.style.width = '300px';
              
              modal.innerHTML = `
                <h3 class="modal-title">Pick a date</h3>
                <input type="date" class="date-picker-modal-input" id="inline-date-input">
                <div class="modal-button-container">
                  <button type="button" class="modal-button modal-cancel-btn">Cancel</button>
                  <button type="button" class="modal-button modal-confirm-btn">Confirm</button>
                </div>
              `;
              document.body.appendChild(modal);
              inlineActiveModal = modal;
              
              // Position modal under the button
              positionModalBelowButton(modal, dateBtn);
              
              // Prevent clicks inside the modal from closing it
              modal.addEventListener('click', function(e) {
                e.stopPropagation();
              });
              
              // Focus the input and show picker
              const input = modal.querySelector('input');
              setTimeout(() => {
                input.focus();
                if (input.showPicker) input.showPicker();
              }, 100);
              
              // Button handlers
              modal.querySelector('.modal-cancel-btn').onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                modal.remove();
                inlineActiveModal = null;
              };
              
              modal.querySelector('.modal-confirm-btn').onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const dueDateInput = document.getElementById('due-date-input');
                const dateValue = input.value;
                
                if (dateValue && dueDateInput) {
                  dueDateInput.value = dateValue;
                  dateBtn.classList.add('active');
                  
                  // Update button text
                  const date = new Date(dateValue + 'T00:00:00');
                  const today = new Date();
                  today.setHours(0,0,0,0);
                  
                  if (date.toDateString() === today.toDateString()) {
                    dateBtn.innerHTML = '<i class="far fa-calendar mr-2"></i>Today';
                  } else {
                    const options = { month: 'short', day: 'numeric' };
                    dateBtn.innerHTML = `<i class="far fa-calendar mr-2"></i>${date.toLocaleDateString(undefined, options)}`;
                  }
                  
                  // Update selected-dates pills if available
                  const selectedDatesContainer = document.getElementById('selected-dates');
                  if (selectedDatesContainer) {
                    let className = 'bg-primary-container text-on-primary-container';
                    let displayText = 'Today';
                    
                    if (!date.toDateString() === today.toDateString()) {
                      displayText = date.toLocaleDateString(undefined, options);
                      className = 'bg-tertiary-container text-on-tertiary-container';
                    }
                    
                    selectedDatesContainer.innerHTML = `
                      <span class="form-date-pill inline-flex items-center text-sm px-2.5 py-1 rounded-full ${className}">
                        ${displayText}
                        <button type="button" class="pill-delete-btn ml-1.5">&times;</button>
                      </span>
                    `;
                    selectedDatesContainer.classList.remove('hidden');
                    
                    // Add delete button handler
                    const deleteBtn = selectedDatesContainer.querySelector('.pill-delete-btn');
                    if (deleteBtn) {
                      deleteBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        selectedDatesContainer.innerHTML = '';
                        selectedDatesContainer.classList.add('hidden');
                        dueDateInput.value = '';
                        dateBtn.classList.remove('active');
                        dateBtn.innerHTML = '<i class="far fa-calendar mr-2"></i>Due Date';
                      };
                    }
                  }
                }
                
                modal.remove();
                inlineActiveModal = null;
              };
            };
            console.log("Added direct handler to date button");
          }
          
          // Category button handler
          const categoryBtn = document.getElementById('toggle-category-btn');
          if (categoryBtn) {
            categoryBtn.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Category button clicked via direct handler");
              
              // Close any existing modals first
              closeInlineModals();
              
              // Create a simple category modal
              const modal = document.createElement('div');
              modal.className = 'category-modal';
              
              // Set styles for the modal
              modal.style.backgroundColor = '#fff';
              modal.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
              modal.style.borderRadius = '8px';
              modal.style.padding = '20px';
              modal.style.maxWidth = '90%';
              modal.style.width = '300px';
              
              modal.innerHTML = `
                <h3 class="modal-title">Enter Category</h3>
                <input type="text" class="category-modal-input" id="inline-category-input" placeholder="Add category (e.g., Work, Personal)">
                <div class="modal-button-container">
                  <button type="button" class="modal-button modal-cancel-btn">Cancel</button>
                  <button type="button" class="modal-button modal-confirm-btn">Confirm</button>
                </div>
              `;
              document.body.appendChild(modal);
              inlineActiveModal = modal;
              
              // Position modal under the button
              positionModalBelowButton(modal, categoryBtn);
              
              // Prevent clicks inside the modal from closing it
              modal.addEventListener('click', function(e) {
                e.stopPropagation();
              });
              
              // Focus the input
              const input = modal.querySelector('input');
              input.focus();
              
              // Button handlers
              modal.querySelector('.modal-cancel-btn').onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                modal.remove();
                inlineActiveModal = null;
              };
              
              modal.querySelector('.modal-confirm-btn').onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                const categoryInput = document.getElementById('category-input');
                const categoryValue = input.value;
                
                if (categoryInput) {
                  categoryInput.value = categoryValue;
                  
                  if (categoryValue) {
                    categoryBtn.classList.add('active');
                    categoryBtn.innerHTML = `<i class="fas fa-tags mr-2"></i>${categoryValue}`;
                  } else {
                    categoryBtn.classList.remove('active');
                    categoryBtn.innerHTML = '<i class="fas fa-tags mr-2"></i>Category';
                  }
                }
                
                modal.remove();
                inlineActiveModal = null;
              };
            };
            console.log("Added direct handler to category button");
          }
          
          // Filter buttons
          ['filter-all', 'filter-todo', 'filter-done', 'filter-overdue'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
              btn.onclick = function(e) {
                e.preventDefault();
                console.log(`Filter ${id} clicked via direct handler`);
                
                // Remove active class from all filters
                document.querySelectorAll('#filter-bar button').forEach(b => {
                  b.classList.remove('active', 'bg-primary', 'text-on-primary');
                  b.classList.add('bg-surface-container', 'text-on-surface-variant');
                });
                
                // Add active class to this filter
                btn.classList.add('active', 'bg-primary', 'text-on-primary');
                btn.classList.remove('bg-surface-container', 'text-on-surface-variant');
                
                // Try to trigger the appropriate rendering
                try {
                  const event = new CustomEvent('filter-change', { 
                    detail: { filterId: id } 
                  });
                  document.dispatchEvent(event);
                } catch(err) {
                  console.error("Error dispatching filter event:", err);
                }
              };
            }
          });
          
        } catch(err) {
          console.error("Error setting up direct handlers:", err);
        }
      }, 500);
    });
  </script>
  <script src="js/darkMode.js" defer></script>
</head>
<body class="p-8">
    <!-- Desktop Sidebar (fixed position) -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">ToDodo</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-link" data-view="tasks">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </a>
            <a href="#" class="nav-link" data-view="calendar">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
            <a href="#" class="nav-link nav-link-disabled">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
                <span class="coming-soon">Soon</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="checkbox">
                    <input type="checkbox" id="checkbox" />
                    <div class="slider round">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </div>
                </label>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="app-wrapper">
        <div class="app-container">
            <h1 id="app-title" class="text-center text-on-surface text-3xl font-bold mb-6">Your To-Do List</h1>

            <!-- Add To-Do Form -->
            <form id="todo-form" class="mb-6 w-full">
                <div class="input-group flex items-start gap-2 w-full">
                    <div class="main-input-container flex-grow flex flex-col gap-3">
                        <!-- Changed input to textarea for better multiline support -->
                        <textarea id="todo-input" class="w-full px-4 py-3 border border-outline rounded-lg text-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary-container resize-y min-h-[4rem]" placeholder="Add a new task..." required></textarea>
                        
                        <div class="options-container w-full flex flex-col gap-2">
                            <div class="options-buttons flex gap-2 flex-wrap">
                                <button type="button" id="toggle-date-btn" class="text-sm px-4 py-2 bg-surface-container-high border border-outline rounded-full cursor-pointer transition duration-200 ease-in-out flex-1 min-w-[120px] text-center text-on-surface-variant hover:bg-surface-container-highest active:bg-primary-container active:text-on-primary-container active:border-primary">
                                    <i class="far fa-calendar mr-2"></i> Date
                                </button>
                                <button type="button" id="toggle-category-btn" class="text-sm px-4 py-2 bg-surface-container-high border border-outline rounded-full cursor-pointer transition duration-200 ease-in-out flex-1 min-w-[120px] text-center text-on-surface-variant hover:bg-surface-container-highest active:bg-primary-container active:text-on-primary-container active:border-primary">
                                    <i class="fas fa-tags mr-2"></i> Category
                                </button>
                            </div>
                            
                            <div class="options-inputs flex flex-col gap-2 w-full relative">
                                <!-- The "relative" class on the parent is important for absolute positioning -->
                                <input type="date" id="due-date-input" class="hidden date-input-hidden">
                                
                                <input type="text" id="category-input" class="px-3 py-2 border border-outline rounded-lg w-full box-border text-on-surface hidden" placeholder="Add category (e.g., Work, Personal)" list="category-list" aria-label="Category">
                                <datalist id="category-list"></datalist>
                            </div>

                            <!-- Make sure this is in your HTML near the date input -->
                            <div id="selected-dates" class="selected-pills-container hidden"></div>
                        </div>
                    </div>
                    
                    <button type="submit" title="Add task" class="add-btn w-12 h-12 flex-shrink-0 bg-primary text-on-primary rounded-xl text-2xl flex items-center justify-center cursor-pointer transition duration-200 ease-in-out hover:bg-primary/90 active:scale-105 shadow-md self-start">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </form>

            <!-- Filter Bar -->
            <div id="filter-bar" class="flex flex-wrap gap-2 my-6 pb-3 w-full border-b border-outline-variant">
                <button id="filter-all" class="filter-button">All</button>
                <button id="filter-todo" class="filter-button">Pending</button>
                <button id="filter-done" class="filter-button">Completed</button>
                <button id="filter-overdue" class="filter-button">Overdue</button>
                
                <!-- Dynamic Category Filters -->
                <div id="category-filters" class="flex flex-wrap gap-2">
                    <!-- Category filter pills will be added here by JS -->
                </div>
                 <div id="tag-filters" class="flex flex-wrap gap-2">
                    <!-- Tag filter pills will be added here by JS -->
                </div>
            </div>

            <!-- Task List -->
            <ul id="todo-list" class="todo-list">
                <!-- The empty state div should be inside the todo-list -->
                <div id="empty-state" class="empty-state">No tasks here!</div>
            </ul>
        </div>
        
        <!-- Calendar Container -->
        <div id="calendar-container" class="calendar-container">
            <!-- Calendar will be rendered here by JavaScript -->
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <a href="#" class="mobile-nav-link" data-view="tasks" onclick="switchMobileView('tasks')">
            <i class="fas fa-tasks"></i>
            <span>Tasks</span>
        </a>
        <a href="#" class="mobile-nav-link" data-view="calendar" onclick="switchMobileView('calendar')">
            <i class="fas fa-calendar-alt"></i>
            <span>Calendar</span>
        </a>
        <a href="#" class="mobile-nav-link nav-link-disabled">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
        <a href="#" class="mobile-nav-link mobile-theme-toggle" onclick="toggleMobileTheme(); return false;">
            <i class="fas fa-moon"></i>
            <span>Theme</span>
        </a>
    </nav>

  <script type="module" src="js/app.js"></script>
  <!-- Simple direct script for mobile navigation -->
  <script>
    // Direct mobile view switching
    function switchMobileView(view) {
      console.log('Mobile view switching to:', view);
      
      // Update active classes
      document.querySelectorAll('.mobile-nav-link').forEach(link => {
        if (link.getAttribute('data-view') === view) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
      
      // Update desktop sidebar links to match
      document.querySelectorAll('.nav-link').forEach(link => {
        if (link.getAttribute('data-view') === view) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
      
      // Switch the view
      const appContainer = document.querySelector('.app-container');
      const calendarContainer = document.getElementById('calendar-container');
      
      if (view === 'tasks') {
        appContainer.style.display = 'flex';
        calendarContainer.style.display = 'none';
      } else if (view === 'calendar') {
        appContainer.style.display = 'none';
        calendarContainer.style.display = 'flex';
        
        // Make sure calendar renders
        if (window.Calendar && typeof window.Calendar.renderCalendar === 'function') {
          window.Calendar.renderCalendar();
        }
      }
      
      // Save preference
      localStorage.setItem('current-view', view);
      
      // Prevent default action
      return false;
    }
    
    // Toggle theme for mobile
    function toggleMobileTheme() {
      const checkbox = document.getElementById('checkbox');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        
        // Trigger the change event on the checkbox
        const event = new Event('change');
        checkbox.dispatchEvent(event);
        
        // Update mobile button icon
        updateMobileThemeIcon();
      }
    }
    
    // Update mobile theme icon based on current theme
    function updateMobileThemeIcon() {
      const currentTheme = localStorage.getItem('theme');
      const themeToggle = document.querySelector('.mobile-theme-toggle i');
      
      if (themeToggle) {
        if (currentTheme === 'dark') {
          themeToggle.className = 'fas fa-sun';
        } else {
          themeToggle.className = 'fas fa-moon';
        }
      }
    }
    
    // Set initial view on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedView = localStorage.getItem('current-view') || 'tasks';
      switchMobileView(savedView);
      
      // Set initial theme icon
      updateMobileThemeIcon();
    });
  </script>
</body>
</html>
